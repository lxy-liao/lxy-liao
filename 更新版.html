<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一触即学 - 妇婴手术室仪器智能教学系统 (增强版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入Chart.js用于图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 标题栏Logo样式 */
        .header {
            position: relative;
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #1a6dcc 0%, #0d4d9c 100%);
            color: white;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(13, 77, 156, 0.2);
            margin-bottom: 30px;
        }
        
        .header-logo {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            height: 115px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .header-title {
            display: inline-block;
            max-width: 80%;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f9fc;
            color: #333;
            line-height: 1.6;
            padding-bottom: 50px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .instrument-panel,
        .learning-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .instrument-panel {
            flex: 1;
            min-width: 300px;
        }
        
        .learning-panel {
            flex: 2;
            min-width: 300px;
        }
        
        h2 {
            color: #1a6dcc;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instrument-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
        }
        
        .instrument-card {
            position: relative;
            background: #f8fafd;
            border: 2px solid #e1e8f2;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .instrument-card:hover {
            transform: translateY(-5px);
            border-color: #1a6dcc;
            box-shadow: 0 7px 14px rgba(26, 109, 204, 0.15);
        }
        
        .instrument-card.active {
            border-color: #1a6dcc;
            background-color: #eef5ff;
        }
        
        .instrument-icon {
            font-size: 2.5rem;
            color: #1a6dcc;
            margin-bottom: 10px;
        }
        
        .instrument-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }
        
        .repair-btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 5px;
            width: 100%;
        }
        
        .repair-btn:hover {
            background-color: #ff5252;
        }
        
        .nfc-simulation {
            text-align: center;
            padding: 20px;
            background: linear-gradient(to right, #f0f7ff, #e6f0ff);
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px dashed #a3c7f7;
        }
        
        .nfc-icon {
            font-size: 4rem;
            color: #1a6dcc;
            margin-bottom: 15px;
        }
        
        .video-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .video-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        #learningVideo {
            width: 100%;
            display: block;
        }
        
        .video-info {
            padding: 15px;
            background: #f8fafd;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        
        .video-info.active {
            display: block;
        }
        
        .dashboard-panel {
            flex: 100%;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8fafd;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #1a6dcc;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-top: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #1a6dcc;
            border-bottom: 3px solid #1a6dcc;
        }
        
        .tab-content {
            display: none;
            padding-top: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background-color: #f8fafd;
            font-weight: 600;
        }
        
        .status-pending {
            color: #ff9800;
            font-weight: 600;
        }
        
        .status-fixed {
            color: #4caf50;
            font-weight: 600;
        }
        
        .status-urgent {
            color: #f44336;
            font-weight: 600;
        }
        
        .repair-form {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .repair-form.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header-logo {
                position: relative;
                left: 0;
                top: 0;
                transform: none;
                height: 80px;
                margin-bottom: 15px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .btn {
            display: inline-block;
            background: #1a6dcc;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #0d4d9c;
        }
        
        .btn-repair {
            background: #ff6b6b;
        }
        
        .btn-repair:hover {
            background: #ff5252;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .tip {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://your-hospital-touch-learn.oss-cn-guangzhou.aliyuncs.com/%E5%9B%BE%E7%89%871.png"
             alt="妇婴手术室 Logo"
             class="header-logo">
        <div class="header-title">
            <h1><i class="fas fa-stethoscope"></i> 一触即学：妇婴手术室仪器智能教学系统</h1>
            <p>增强版 | 模拟NFC触碰 → 秒级学习 → 仪器报修 → 数据驱动管理</p>
        </div>
    </div>
    
    <div class="container">
        <div class="main-content">
            <section class="instrument-panel">
                <h2><i class="fas fa-tools"></i> 选择仪器进行模拟触碰</h2>
                <p class="tip">点击仪器卡学习，点击"模拟报修"按钮模拟通过NFC标签报修</p>
                <div class="instrument-list" id="instrumentList">
                    <!-- 仪器卡片将通过JS动态生成 -->
                </div>
            </section>
            
            <section class="learning-panel">
                <h2><i class="fas fa-play-circle"></i> 学习区域</h2>
                <div class="nfc-simulation">
                    <div class="nfc-icon"><i class="fas fa-wifi"></i></div>
                    <h3>模拟NFC触碰成功！</h3>
                    <p>系统已识别仪器：<strong id="currentInstrument">[请先选择左侧仪器]</strong></p>
                    <p class="tip">在真实场景中，此过程由手机贴近仪器NFC标签自动完成。</p>
                </div>
                <div id="videoContainer" class="video-container"></div>
                <div id="videoInfo" class="video-info">
                    <h4><i class="fas fa-info-circle"></i> 学习记录已生成</h4>
                    <p>本次学习：<strong id="learnedTopic">基础操作</strong> | 时长：<strong>1分45秒</strong></p>
                    <p>学习时间：<span id="learnTime">--</span> | 状态：<span class="status-complete">已完成</span></p>
                    <button class="btn" onclick="resetLearning()"><i class="fas fa-redo"></i> 模拟学习下一个仪器</button>
                </div>
                
                <!-- 报修表单 -->
                <div id="repairForm" class="repair-form">
                    <h3><i class="fas fa-wrench"></i> 仪器报修</h3>
                    <div class="form-group">
                        <label for="repairInstrument">报修仪器</label>
                        <input type="text" id="repairInstrument" readonly>
                    </div>
                    <div class="form-group">
                        <label for="repairType">故障类型</label>
                        <select id="repairType">
                            <option value="硬件故障">硬件故障</option>
                            <option value="软件故障">软件故障</option>
                            <option value="电源问题">电源问题</option>
                            <option value="屏幕异常">屏幕异常</option>
                            <option value="其他问题">其他问题</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="repairPriority">紧急程度</label>
                        <select id="repairPriority">
                            <option value="一般">一般 (24小时内处理)</option>
                            <option value="紧急">紧急 (4小时内处理)</option>
                            <option value="非常紧急">非常紧急 (立即处理)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="repairDescription">故障描述</label>
                        <textarea id="repairDescription" placeholder="请详细描述故障现象..."></textarea>
                    </div>
                    <button class="btn btn-repair" onclick="submitRepair()"><i class="fas fa-paper-plane"></i> 提交报修</button>
                    <button class="btn btn-secondary" onclick="cancelRepair()">取消</button>
                </div>
            </section>
            
            <section class="dashboard-panel">
                <h2><i class="fas fa-chart-line"></i> 数据管理驾驶舱</h2>
                <p class="tip">后台实时统计学习行为与仪器状态，为管理者提供决策支持</p>
                
                <div class="stats-container">
                    <div class="stat-card"><h4>今日学习次数</h4><p id="statToday">0</p></div>
                    <div class="stat-card"><h4>累计学习人次</h4><p id="statTotal">1429</p></div>
                    <div class="stat-card"><h4>最常用仪器</h4><p id="statTopInstrument">自体血回输机</p></div>
                    <div class="stat-card"><h4>待处理报修</h4><p id="statRepairs">0</p></div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h4><i class="fas fa-chart-pie"></i> 仪器学习次数占比</h4>
                        <div class="chart-container">
                            <canvas id="instrumentChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h4><i class="fas fa-chart-line"></i> 近7天学习趋势</h4>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="learning">学习记录</div>
                    <div class="tab" data-tab="repair">报修记录</div>
                </div>
                
                <div class="tab-content active" id="learningTab">
                    <h3>近期学习记录</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>护士(匿名)</th>
                                <th>仪器</th>
                                <th>学习内容</th>
                                <th>时长</th>
                            </tr>
                        </thead>
                        <tbody id="learningLog"></tbody>
                    </table>
                </div>
                
                <div class="tab-content" id="repairTab">
                    <h3>仪器报修记录</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>报修时间</th>
                                <th>仪器</th>
                                <th>故障类型</th>
                                <th>紧急程度</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="repairLog"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <script>
        // 仪器数据库 - 所有视频均已替换为您的OSS链接
        const instrumentDB = {
            1: { 
                name: "自体血回输机", 
                videoTitle: "自体回收机的使用方法", 
                videoDesc: "详细演示自体血回收机的操作流程与注意事项。", 
                videoSrc: "https://your-hospital-touch-learn.oss-cn-guangzhou.aliyuncs.com/%E8%A7%86%E9%A2%91.mp4",
                usageCount: 320,
                repairCount: 2
            },
            2: { 
                name: "高频电刀", 
                videoTitle: "高频电刀基础操作与安全须知", 
                videoDesc: "涵盖开机自检、模式选择、功率调节及电极板粘贴规范。", 
                videoSrc: "https://vjs.zencdn.net/v/oceans.mp4",
                usageCount: 280,
                repairCount: 1
            },
            3: { 
                name: "监护仪", 
                videoTitle: "多参数监护仪报警处理流程", 
                videoDesc: "详解常见报警（ECG、SpO2、NIBP）的识别与快速处理步骤。", 
                videoSrc: "https://vjs.zencdn.net/v/oceans.mp4",
                usageCount: 410,
                repairCount: 3
            },
            4: { 
                name: "麻醉机", 
                videoTitle: "麻醉机术前检查与参数设置", 
                videoDesc: "完整演示麻醉机的晨检流程以及常见通气模式设置。", 
                videoSrc: "https://your-hospital-touch-learn.oss-cn-guangzhou.aliyuncs.com/%E8%A7%86%E9%A2%91.mp4",
                usageCount: 190,
                repairCount: 1
            },
            5: { 
                name: "呼吸机", 
                videoTitle: "呼吸机紧急情况应急预案", 
                videoDesc: "当呼吸机突然报警或故障时，护士应立即采取的核对与处理措施。", 
                videoSrc: "https://your-hospital-touch-learn.oss-cn-guangzhou.aliyuncs.com/%E8%A7%86%E9%A2%91.mp4",
                usageCount: 350,
                repairCount: 2
            },
            6: { 
                name: "输液泵", 
                videoTitle: "靶控输液泵药物配置与运行", 
                videoDesc: "演示如何正确配置镇痛/镇静药物，并设置靶控输注模式。", 
                videoSrc: "https://your-hospital-touch-learn.oss-cn-guangzhou.aliyuncs.com/%E8%A7%86%E9%A2%91.mp4",
                usageCount: 260,
                repairCount: 0
            }
        };

        // 图表实例
        let instrumentChart, trendChart;
        // 报修记录
        let repairRecords = [
            {id: 1, instrumentId: 3, instrumentName: "监护仪", type: "屏幕异常", priority: "紧急", status: "待处理", time: "2023-10-15 14:30", description: "屏幕闪烁，显示不清晰"},
            {id: 2, instrumentId: 5, instrumentName: "呼吸机", type: "硬件故障", priority: "一般", status: "处理中", time: "2023-10-14 09:15", description: "氧气流量传感器异常"},
            {id: 3, instrumentId: 1, instrumentName: "自体血回输机", type: "软件故障", priority: "一般", status: "已修复", time: "2023-10-12 16:45", description: "系统启动时卡在自检界面"}
        ];

        let currentInstrumentId = null;
        let todayCount = 0;
        let learningRecords = [];

        document.addEventListener('DOMContentLoaded', function() {
            initializeInstrumentCards();
            initializeCharts();
            updateLearningLog();
            updateRepairLog();
            updateDashboard();
            
            // 标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });
        });

        // 初始化仪器卡片
        function initializeInstrumentCards() {
            const instrumentList = document.getElementById('instrumentList');
            instrumentList.innerHTML = '';
            
            for (const [id, instrument] of Object.entries(instrumentDB)) {
                const card = document.createElement('div');
                card.className = 'instrument-card';
                card.setAttribute('data-id', id);
                card.innerHTML = `
                    <div class="instrument-icon"><i class="fas fa-${getInstrumentIcon(id)}"></i></div>
                    <div class="instrument-name">${instrument.name}</div>
                    <div class="usage-count">学习次数: ${instrument.usageCount}</div>
                    <button class="repair-btn" onclick="simulateRepair(${id}, '${instrument.name}')"><i class="fas fa-wrench"></i> 模拟报修</button>
                `;
                
                card.addEventListener('click', function(e) {
                    // 防止点击报修按钮时触发选择仪器
                    if (!e.target.classList.contains('repair-btn')) {
                        selectInstrument(id);
                    }
                });
                
                instrumentList.appendChild(card);
            }
        }

        // 获取仪器图标
        function getInstrumentIcon(id) {
            const icons = {
                1: 'recycle',
                2: 'bolt',
                3: 'heartbeat',
                4: 'wind',
                5: 'lungs',
                6: 'tint'
            };
            return icons[id] || 'toolbox';
        }

        // 选择仪器进行学习
        function selectInstrument(instrumentId) {
            currentInstrumentId = instrumentId;
            const instrument = instrumentDB[instrumentId];
            
            // 更新仪器卡片状态
            document.querySelectorAll('.instrument-card').forEach(card => {
                card.classList.remove('active');
                if(card.getAttribute('data-id') == instrumentId) card.classList.add('active');
            });
            
            // 更新界面信息
            document.getElementById('currentInstrument').textContent = instrument.name;
            const videoContainer = document.getElementById('videoContainer');
            
            // 使用 video 标签播放 .mp4 直链
            videoContainer.innerHTML = `
                <h4 style="color:white; padding:15px; background:rgba(0,0,0,0.7); margin:0;">
                    <i class="fas fa-video"></i> ${instrument.videoTitle}
                </h4>
                <video id="learningVideo" controls controlsList="nodownload" onended="completeLearning()" style="width:100%; display:block;">
                    <source src="${instrument.videoSrc}" type="video/mp4">
                    您的浏览器不支持视频标签。
                </video>
            `;
            
            videoContainer.classList.add('active');
            document.getElementById('learnedTopic').textContent = instrument.videoTitle;
            const now = new Date();
            document.getElementById('learnTime').textContent = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            document.getElementById('videoInfo').classList.remove('active');
            
            // 隐藏报修表单
            document.getElementById('repairForm').classList.remove('active');
            
            // 更新数据
            todayCount++;
            instrumentDB[instrumentId].usageCount++;
            updateDashboard();
            updateCharts();
        }

        // 完成学习
        function completeLearning() {
            document.getElementById('videoInfo').classList.add('active');
            addLearningLog();
        }

        // 重置学习
        function resetLearning() {
            document.getElementById('videoContainer').classList.remove('active');
            document.getElementById('videoInfo').classList.remove('active');
            document.querySelectorAll('.instrument-card').forEach(card => card.classList.remove('active'));
            document.getElementById('currentInstrument').textContent = '[请先选择左侧仪器]';
        }

        // 模拟报修
        function simulateRepair(instrumentId, instrumentName) {
            currentInstrumentId = instrumentId;
            const repairForm = document.getElementById('repairForm');
            document.getElementById('repairInstrument').value = instrumentName;
            
            // 显示报修表单
            repairForm.classList.add('active');
            
            // 隐藏学习视频
            document.getElementById('videoContainer').classList.remove('active');
            document.getElementById('videoInfo').classList.remove('active');
            
            // 滚动到表单位置
            repairForm.scrollIntoView({behavior: 'smooth', block: 'nearest'});
        }

        // 提交报修
        function submitRepair() {
            const instrumentId = currentInstrumentId;
            const instrumentName = document.getElementById('repairInstrument').value;
            const repairType = document.getElementById('repairType').value;
            const repairPriority = document.getElementById('repairPriority').value;
            const repairDescription = document.getElementById('repairDescription').value;
            
            if (!repairDescription.trim()) {
                alert('请填写故障描述！');
                return;
            }
            
            // 创建报修记录
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            const newRepair = {
                id: repairRecords.length + 1,
                instrumentId: instrumentId,
                instrumentName: instrumentName,
                type: repairType,
                priority: repairPriority,
                status: "待处理",
                time: timeStr,
                description: repairDescription
            };
            
            // 添加到报修记录
            repairRecords.unshift(newRepair);
            
            // 更新仪器报修次数
            instrumentDB[instrumentId].repairCount++;
            
            // 更新界面
            updateRepairLog();
            updateDashboard();
            updateCharts();
            
            // 重置表单并隐藏
            document.getElementById('repairDescription').value = '';
            document.getElementById('repairForm').classList.remove('active');
            
            // 显示成功消息
            alert(`报修成功！\n仪器：${instrumentName}\n紧急程度：${repairPriority}\n报修单号：REP-${newRepair.id.toString().padStart(4, '0')}`);
            
            // 自动切换到报修记录标签页
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab[data-tab="repair"]').classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('repairTab').classList.add('active');
        }

        // 取消报修
        function cancelRepair() {
            document.getElementById('repairForm').classList.remove('active');
            document.getElementById('repairDescription').value = '';
        }

        // 更新学习记录
        function updateLearningLog() {
            const logTable = document.getElementById('learningLog');
            logTable.innerHTML = '';
            
            // 生成模拟学习记录
            const instruments = Object.values(instrumentDB);
            const nurses = ['Nurse_01', 'Nurse_05', 'Nurse_12', 'Nurse_23', 'Nurse_30'];
            const hours = ['09','10','11','14','15','16'];
            const minutes = ['05','15','20','30','45','50'];
            
            for(let i=0; i<6; i++) {
                const inst = instruments[Math.floor(Math.random()*instruments.length)];
                const nurse = nurses[Math.floor(Math.random()*nurses.length)];
                const hour = hours[Math.floor(Math.random()*hours.length)];
                const minute = minutes[Math.floor(Math.random()*minutes.length)];
                const duration = `${Math.floor(Math.random()*2)+1}:${Math.floor(Math.random()*60).toString().padStart(2,'0')}`;
                
                const logEntry = document.createElement('tr');
                logEntry.innerHTML = `
                    <td>4/${15+i} ${hour}:${minute}</td>
                    <td>${nurse}</td>
                    <td>${inst.name}</td>
                    <td>${inst.videoTitle.substring(0,25)}...</td>
                    <td>${duration}</td>
                `;
                logTable.appendChild(logEntry);
                
                // 保存到学习记录数组
                learningRecords.push({
                    date: `4/${15+i}`,
                    instrument: inst.name,
                    nurse: nurse
                });
            }
        }

        // 更新报修记录
        function updateRepairLog() {
            const repairTable = document.getElementById('repairLog');
            repairTable.innerHTML = '';
            
            // 显示所有报修记录
            repairRecords.forEach(record => {
                const statusClass = record.status === '待处理' ? 'status-pending' : 
                                  record.status === '处理中' ? 'status-urgent' : 'status-fixed';
                
                const priorityClass = record.priority === '非常紧急' ? 'status-urgent' : 
                                    record.priority === '紧急' ? 'status-pending' : '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.time}</td>
                    <td>${record.instrumentName}</td>
                    <td>${record.type}</td>
                    <td class="${priorityClass}">${record.priority}</td>
                    <td class="${statusClass}">${record.status}</td>
                    <td>
                        <button class="repair-btn" style="padding: 5px 8px; font-size: 0.75rem;" 
                                onclick="changeRepairStatus(${record.id})">
                            ${record.status === '已修复' ? '重新打开' : '标记为已修复'}
                        </button>
                    </td>
                `;
                repairTable.appendChild(row);
            });
            
            // 更新待处理报修数量
            const pendingRepairs = repairRecords.filter(r => r.status !== '已修复').length;
            document.getElementById('statRepairs').textContent = pendingRepairs;
        }

        // 更改报修状态
        function changeRepairStatus(repairId) {
            const recordIndex = repairRecords.findIndex(r => r.id === repairId);
            if (recordIndex !== -1) {
                if (repairRecords[recordIndex].status === '已修复') {
                    repairRecords[recordIndex].status = '待处理';
                } else {
                    repairRecords[recordIndex].status = '已修复';
                }
                updateRepairLog();
            }
        }

        // 添加学习记录
        function addLearningLog() {
            if(!currentInstrumentId) return;
            
            const instrument = instrumentDB[currentInstrumentId];
            const now = new Date();
            const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            const nurses = ['Nurse_01', 'Nurse_05', 'Nurse_12', 'Nurse_23'];
            const durations = ['1:45', '2:10', '0:55', '3:20'];
            const randomNurse = nurses[Math.floor(Math.random()*nurses.length)];
            const randomDuration = durations[Math.floor(Math.random()*durations.length)];
            
            const logTable = document.getElementById('learningLog');
            const logEntry = document.createElement('tr');
            logEntry.innerHTML = `
                <td>${timeStr}</td>
                <td>${randomNurse}</td>
                <td>${instrument.name}</td>
                <td>${instrument.videoTitle.substring(0,25)}...</td>
                <td>${randomDuration}</td>
            `;
            
            logTable.insertBefore(logEntry, logTable.firstChild);
            if(logTable.children.length > 8) logTable.removeChild(logTable.lastChild);
            
            // 更新累计学习人次
            const totalStat = document.getElementById('statTotal');
            totalStat.textContent = parseInt(totalStat.textContent) + 1;
            
            // 添加到学习记录数组
            learningRecords.unshift({
                date: `${now.getMonth()+1}/${now.getDate()}`,
                instrument: instrument.name,
                nurse: randomNurse
            });
            
            // 更新图表
            updateCharts();
        }

        // 更新仪表板
        function updateDashboard() {
            document.getElementById('statToday').textContent = todayCount;
            
            // 更新最常用仪器
            let maxUsage = 0;
            let topInstrument = "自体血回输机";
            for (const [id, instrument] of Object.entries(instrumentDB)) {
                if (instrument.usageCount > maxUsage) {
                    maxUsage = instrument.usageCount;
                    topInstrument = instrument.name;
                }
            }
            document.getElementById('statTopInstrument').textContent = topInstrument;
        }

        // 初始化图表
        function initializeCharts() {
            // 仪器使用情况饼图
            const instrumentCtx = document.getElementById('instrumentChart').getContext('2d');
            instrumentChart = new Chart(instrumentCtx, {
                type: 'pie',
                data: {
                    labels: Object.values(instrumentDB).map(i => i.name),
                    datasets: [{
                        data: Object.values(instrumentDB).map(i => i.usageCount),
                        backgroundColor: [
                            '#1a6dcc', '#36a2eb', '#ff6384', '#ff9f40', '#4bc0c0', '#9966ff'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} 次 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 学习趋势折线图
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['7天前', '6天前', '5天前', '4天前', '3天前', '2天前', '昨天'],
                    datasets: [{
                        label: '学习次数',
                        data: [32, 45, 28, 51, 39, 48, 43],
                        borderColor: '#1a6dcc',
                        backgroundColor: 'rgba(26, 109, 204, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '学习次数'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    }
                }
            });
        }

        // 更新图表
        function updateCharts() {
            // 更新饼图数据
            instrumentChart.data.datasets[0].data = Object.values(instrumentDB).map(i => i.usageCount);
            instrumentChart.update();
            
            // 更新折线图数据（模拟随机波动）
            const currentData = trendChart.data.datasets[0].data;
            const newValue = todayCount * 2 + Math.floor(Math.random() * 10);
            currentData.shift();
            currentData.push(newValue);
            trendChart.update();
        }
    </script>
</body>
</html>